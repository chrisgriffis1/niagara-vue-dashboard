<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üîç Real-Time Diagnostic</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        .section {
            background: #252526;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .success { border-left-color: #4caf50; }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        h1 { color: #569cd6; margin-top: 0; }
        h2 { color: #4ec9b0; font-size: 18px; margin-top: 0; }
        pre { 
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
        .highlight { color: #ce9178; font-weight: bold; }
        .pass { color: #4caf50; }
        .fail { color: #f44336; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #005a9e; }
        .live-log {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry { margin: 4px 0; }
        .log-info { color: #4fc3f7; }
        .log-success { color: #66bb6a; }
        .log-error { color: #ef5350; }
        .log-warn { color: #ffa726; }
    </style>
</head>
<body>
    <h1>üîç Real-Time Dashboard Diagnostic</h1>
    
    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="runFullDiagnostic()">üî¨ Run Full Diagnostic</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button onclick="copyResults()">üìã Copy Results</button>
    </div>

    <div id="results"></div>
    
    <div class="section">
        <h2>üìä Live Console Output</h2>
        <div id="liveLog" class="live-log"></div>
    </div>

    <script type="module">
        import MockDataAdapter from './src/adapters/MockDataAdapter.js';

        const resultsDiv = document.getElementById('results');
        const liveLogDiv = document.getElementById('liveLog');
        let allLogs = [];

        // Capture ALL console output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            allLogs.push({ timestamp, message, type });
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = entry;
            liveLogDiv.appendChild(logEntry);
            liveLogDiv.scrollTop = liveLogDiv.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            addLog(args.join(' '), 'info');
        };
        console.error = (...args) => {
            originalError(...args);
            addLog(args.join(' '), 'error');
        };
        console.warn = (...args) => {
            originalWarn(...args);
            addLog(args.join(' '), 'warn');
        };

        window.clearLogs = () => {
            liveLogDiv.innerHTML = '';
            allLogs = [];
        };

        window.copyResults = () => {
            const text = allLogs.map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            navigator.clipboard.writeText(text);
            alert('Results copied to clipboard!');
        };

        window.runFullDiagnostic = async () => {
            resultsDiv.innerHTML = '';
            clearLogs();
            
            console.log('üî¨ Starting Full Diagnostic...\n');

            try {
                // Test 1: Check file accessibility
                addSection('Test 1: File Accessibility', 'checking');
                console.log('Attempting to load: /mock-data/site-profile-1765425942065.json');
                
                try {
                    const response = await fetch('/mock-data/site-profile-1765425942065.json');
                    if (response.ok) {
                        const size = response.headers.get('content-length');
                        updateSection('Test 1: File Accessibility', 'success', 
                            `‚úÖ File found! Size: ${(size/1024/1024).toFixed(2)} MB`);
                    } else {
                        updateSection('Test 1: File Accessibility', 'error', 
                            `‚ùå File not accessible. Status: ${response.status}`);
                    }
                } catch (err) {
                    updateSection('Test 1: File Accessibility', 'error', 
                        `‚ùå Cannot fetch file: ${err.message}`);
                }

                // Test 2: Create Adapter
                addSection('Test 2: Create Adapter', 'checking');
                console.log('Creating MockDataAdapter instance...');
                const adapter = new MockDataAdapter();
                updateSection('Test 2: Create Adapter', 'success', '‚úÖ Adapter created');

                // Test 3: Check available datasets
                addSection('Test 3: Available Datasets', 'checking');
                const datasets = adapter.availableDatasets;
                let datasetInfo = 'Available datasets:\n';
                datasets.forEach(ds => {
                    datasetInfo += `  - ${ds.id}: ${ds.name} (${ds.file})\n`;
                });
                updateSection('Test 3: Available Datasets', 'success', datasetInfo);

                // Test 4: Get current dataset (before switch)
                addSection('Test 4: Default Dataset', 'checking');
                const currentBefore = adapter.getCurrentDataset();
                updateSection('Test 4: Default Dataset', 'warning', 
                    `Current dataset: ${currentBefore.id} - ${currentBefore.name}`);

                // Test 5: Switch to real data
                addSection('Test 5: Switch to Real Data', 'checking');
                console.log('Attempting to switch to real dataset...');
                const switchResult = await adapter.switchDataset('real');
                
                if (switchResult) {
                    const currentAfter = adapter.getCurrentDataset();
                    updateSection('Test 5: Switch to Real Data', 'success', 
                        `‚úÖ Switched to: ${currentAfter.name}\nFile: ${currentAfter.file}`);
                } else {
                    updateSection('Test 5: Switch to Real Data', 'error', 
                        '‚ùå Failed to switch dataset');
                    return;
                }

                // Test 6: Check equipment count
                addSection('Test 6: Equipment Count', 'checking');
                const devices = await adapter.discoverDevices();
                const expectedCount = 83;
                const actualCount = devices.length;
                
                if (actualCount === expectedCount) {
                    updateSection('Test 6: Equipment Count', 'success', 
                        `‚úÖ CORRECT! Found ${actualCount} equipment (expected ${expectedCount})`);
                } else {
                    updateSection('Test 6: Equipment Count', 'error', 
                        `‚ùå WRONG! Found ${actualCount} equipment (expected ${expectedCount})\nThis means the real data is NOT loading!`);
                }

                // Test 7: Get full statistics
                addSection('Test 7: Full Statistics', 'checking');
                const stats = await adapter.getBuildingStats();
                const statsInfo = `
Dataset: ${stats.datasetName}
Equipment: ${stats.equipmentCount}
Points: ${stats.pointCount}
Schedules: ${stats.scheduleCount}
Histories: ${stats.historyCount}
Tagged Components: ${stats.taggedComponentCount}

Equipment Types:
${Object.entries(stats.equipmentByType).map(([type, count]) => `  - ${type}: ${count}`).join('\n')}
                `;
                updateSection('Test 7: Full Statistics', 'success', statsInfo);

                // Test 8: Sample equipment
                addSection('Test 8: Sample Equipment', 'checking');
                let equipInfo = 'First 10 equipment:\n';
                devices.slice(0, 10).forEach((eq, i) => {
                    equipInfo += `  ${i+1}. ${eq.name} (${eq.type}) - ${eq.pointCount} points\n`;
                });
                updateSection('Test 8: Sample Equipment', 'success', equipInfo);

                // Final verdict
                addSection('üéØ FINAL VERDICT', 'checking');
                if (actualCount === expectedCount) {
                    updateSection('üéØ FINAL VERDICT', 'success', 
                        '‚úÖ SUCCESS! Real Niagara data is loading correctly!\n' +
                        'If your dashboard shows 45 equipment, the issue is in how\n' +
                        'the Vue components are calling the adapter.');
                } else {
                    updateSection('üéØ FINAL VERDICT', 'error', 
                        '‚ùå PROBLEM FOUND! Real data is NOT loading.\n' +
                        'The adapter is still loading demo data.\n' +
                        'Check the console logs above for errors.');
                }

            } catch (error) {
                addSection('üí• CRITICAL ERROR', 'error');
                updateSection('üí• CRITICAL ERROR', 'error', 
                    `Error: ${error.message}\n\nStack: ${error.stack}`);
                console.error('Diagnostic failed:', error);
            }
        };

        function addSection(title, status) {
            const section = document.createElement('div');
            section.className = `section ${status}`;
            section.id = 'section-' + title.replace(/\s+/g, '-');
            section.innerHTML = `<h2>${title}</h2><pre>‚è≥ Running...</pre>`;
            resultsDiv.appendChild(section);
        }

        function updateSection(title, status, content) {
            const section = document.getElementById('section-' + title.replace(/\s+/g, '-'));
            if (section) {
                section.className = `section ${status}`;
                section.innerHTML = `<h2>${title}</h2><pre>${content}</pre>`;
            }
        }

        // Auto-run on load
        console.log('üöÄ Diagnostic page loaded. Click "Run Full Diagnostic" button.');
        
        // Make adapter available in console
        window.testAdapter = new MockDataAdapter();
        console.log('üí° Tip: You can test manually in console using window.testAdapter');
    </script>
</body>
</html>

